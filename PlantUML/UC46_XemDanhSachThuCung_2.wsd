@startuml
title UC46: Xem danh sách thú cưng (Luồng thay thế 2a: Tìm kiếm)

actor Admin
participant ":NextJS (Client)" as Client
participant ":PetController" as Controller
participant ":AuthGuard / :AdminGuard" as Guards
participant ":PetService" as Service
database ":MongoDB" as DB

Admin -> Client: 1. Nhập từ khóa, \nnhấn tìm kiếm
activate Client

Client -> Controller: 2. Gửi Yêu cầu GET \n/admin/pets \n(query: ?search=...)
activate Controller

Controller -> Guards: 3. (NestJS) Xác thực Admin
activate Guards
Guards --> Controller: 4. Xác thực thành công
deactivate Guards

Controller -> Service: 5. findAll(query)
activate Service

Service -> Service: 6. (Logic) Xây dựng pipeline \n(Thêm $match \nvới $regex: search)
Service -> DB: 7. petModel.aggregate(facetPipeline)
activate DB
DB --> Service: 8. Trả về kết quả \n(data, totalItems)
deactivate DB

Service -> Service: 9. (Logic) Tính toán \nphân trang
Service --> Controller: 10. Trả về \nPaginatedResult<PetResponseDto>
deactivate Service

Controller --> Client: 11. 200 OK (data)
deactivate Controller

Client -> Client: 12. (Logic) Cập nhật danh sách
Client --> Admin: 13. Hiển thị \ndanh sách đã lọc
deactivate Client

@enduml