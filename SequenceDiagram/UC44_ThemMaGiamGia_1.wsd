@startuml
title UC44: Thêm mã giảm giá (Luồng chính)

actor Admin
participant ":NextJS (Client)" as Client
participant ":CouponController" as Controller
participant ":AuthGuard / :AdminGuard" as Guards
participant ":CouponService" as Service
database ":MongoDB (CouponCollection)" as DB

Admin -> Client: 1. Nhấn "Thêm mới"
activate Client
Client -> Client: 2. Hiển thị form "Tạo Coupon mới"
Client --> Admin: (Hiển thị form)

Admin -> Client: 3. Điền thông tin (createCouponDto), \nNhấn "Tạo mới"
Client -> Controller: 4. Gửi Yêu cầu POST \n/admin/coupons \n(Body: createCouponDto)
activate Controller

Controller -> Guards: 5. (NestJS) Xác thực Admin
activate Guards
Guards --> Controller: 6. Xác thực thành công
deactivate Guards

Controller -> Service: 7. createCoupon(createCouponDto)
activate Service

Service -> Service: 8. (Logic) Chuyển code sang chữ hoa
Service -> DB: 9. findOne({ code: uppercaseCode }) \n(Kiểm tra trùng lặp)
activate DB
DB --> Service: 10. Trả về (null)
deactivate DB

Service -> Service: 11. (Logic) Kiểm tra \n(expiresAt > startsAt) (OK)
Service -> Service: 12. (Logic) determineApplyType(...)
Service -> DB: 13. new this.couponModel(...).save()
activate DB
DB --> Service: 14. Trả về (newCoupon)
deactivate DB

Service --> Controller: 15. Trả về (newCoupon)
deactivate Service

Controller --> Client: 16. 201 Created (data)
deactivate Controller

Client -> Client: 17. (Logic) Hiển thị \nthông báo thành công
Client --> Admin: 18. Hiển thị mã mới \ntrên giao diện
deactivate Client

@enduml